/** layuiAdmin.pro-v1.0.0-beta7 LPPL License By http://www.layui.com/admin/ */
 ;function new_specifications(e,a,t,i,s,n,c){return e||(e=""),a||(a=""),t||(t=""),i||(i=""),s||(s=""),n||(n=""),c||(c=""),'<div class="layui-form-item" style="display: flex;flex-direction: row;justify-content: flex-start;">\n                    <div class="layui-input-inline" style="text-align: center;">\n                        <span>\n                            <i class="layui-icon layui-icon-face-smile">&#xe61f;</i><input class="addImgPut" type="file"><img class="new_pictures" name="pic_url" src="'+c+'"/>\n                        </span>\n                    </div>\n                    <div class="layui-input-inline">\n                        <span class="unified_style property1_name">'+e+'</span>\n                    </div>\n                    <div class="layui-input-inline ">\n                        <span class="unified_style property2_name">'+a+'</span>\n                    </div>\n                    <div class="layui-input-inline ">\n                        <span class="unified_style">\n                            <span class="asterisk">*</span>价格(元)\n                        </span>\n                        <input name="stock_price" value="'+t+'" lay-verify="required|number" required\n                               class="specification_color1 stock_price">\n                    </div>\n                    <div class="layui-input-inline ">\n                        <span class="unified_style">\n                            <span class="asterisk">*</span>库存：\n                        </span>\n                        <input name="stock_number" value="'+i+'" required lay-verify="required|number"\n                               class="specification_color1 stock_number">\n                    </div>\n                    <div class="layui-input-inline ">\n                        <span class="unified_style">规格编码：</span>\n                        <input name="stock_code" value="'+s+'" required lay-verify="required" class="specification_color1">\n                    </div>\n                    <div class="layui-input-inline ">\n                        <span class="unified_style">成本价：</span>\n                        <input name="stock_cost_price" value="'+n+'" required lay-verify="required|number"\n                               class=" specification_color1">\n                    </div>\n                    <div class="layui-input-inline specifications_delete">\n                        <a class="layui-btn">删除</a>\n                    </div>\n                </div>'}layui.define(function(e){layui.use(["jquery","form","admin","setter","upload"],function(){var e,a,t,i=layui.$,s=layui.form,n=layui.admin,c=layui.setter,r=layui.upload,o=c.baseUrl,l=c.successMsg,p=c.errorMsg,u=c.timeOutCode,d=c.timeOutMsg,m={"Access-Token":layui.data(c.tableName).access_token},f=1,_={shade:.3},y=sessionStorage.getItem("saa_key"),v=sessionStorage.getItem("goods_id");s.render();var g,h=o+"/merchantGoods",k="?key="+y;i.ajax({url:o+"/merchantCategoryType",type:"get",headers:m,beforeSend:function(){a=layer.load(f,_)},success:function(e){if(e.status==u)return layer.msg(d),n.exit(),!1;if(layer.close(a),200!==e.status)return layer.msg(e.message),!1;g=e;for(var t=0;t<e.data.length;t++)if(i("select[name=parent_id]").append("<option value="+e.data[t].id+">"+e.data[t].name+"</option>"),0==t)for(var c=0;c<e.data[0].sub.length;c++)i("select[name=category_id]").append("<option value="+e.data[0].sub[c].id+">"+e.data[0].sub[c].name+"</option>");s.render()},error:function(){layer.msg(p),layer.close(a)}}),s.on("select(parent_id)",function(e){for(var a=e.value,t=g,n=0;n<t.data.length;n++)if(t.data[n].id==a)if(i("select[name=category_id]").empty(),t.data[n].hasOwnProperty("sub"))for(var c=0;c<t.data[n].sub.length;c++)i("select[name=category_id]").append("<option value="+t.data[n].sub[c].id+">"+t.data[n].sub[c].name+"</option>");else layer.msg("当前选择的类目没有数据");s.render()});var b;i.ajax({url:o+"/merchantCategoryTypeMini"+k,type:"get",headers:m,beforeSend:function(){a=layer.load(f,_)},success:function(e){if(e.status==u)return layer.msg(d),n.exit(),!1;if(layer.close(a),200!==e.status)return layer.msg(e.message),!1;b=e;for(var t=0;t<e.data.length;t++)if(i("select[name=m_parent_id]").append("<option value="+e.data[t].id+">"+e.data[t].name+"</option>"),0==t)for(var c=0;c<e.data[0].sub.length;c++)i("select[name=m_category_id]").append("<option value="+e.data[0].sub[c].id+">"+e.data[0].sub[c].name+"</option>");s.render()},error:function(){layer.msg(p),layer.close(a)}}),s.on("select(m_parent_id)",function(e){for(var a=e.value,t=b,n=0;n<t.data.length;n++)if(t.data[n].id==a)if(i("select[name=m_category_id]").empty(),t.data[n].hasOwnProperty("sub"))for(var c=0;c<t.data[n].sub.length;c++)i("select[name=m_category_id]").append("<option value="+t.data[n].sub[c].id+">"+t.data[n].sub[c].name+"</option>");else layer.msg("当前选择的分组没有数据");s.render()});var x,w="",T=[],I=[],F={};r.render({elem:"#putAddBtn",url:o+"/merchantGoodsImg",headers:m,multiple:!0,before:function(e){e.preview(function(e,a,t){x=Math.round(1e9*Math.random()),T.push(x),i("#images").append('<div class="images"><img src="'+t+'" alt="gu'+x+'" class="layui-upload-img goodsImg"><p class="deleteIcon ">&times;</p></div>')})},done:function(e){if(200==e.code){I.push(e.data.src);for(var a=0;a<T.length;a++)F[T[a]]=I[a]}}}),i(document).on("click",".deleteIcon",function(){var e=this.parentNode,a=i(this).prev("img").attr("alt");layer.open({title:"删除",content:"确认删除这张图片吗",yes:function(t){a=a.substr(2,a.length),delete F[a],e.remove(),layer.close(t)}})});var S=window.wangEditor,q=new S("#editor");q.customConfig.debug=location.href.indexOf("wangeditor_debug_mode=1")>0,q.customConfig.uploadImgShowBase64=!0,q.create();var j=0;i(document).on("click",".type",function(){i(".type").attr("class","layui-col-md2 undetail type"),i(this).attr("class","layui-col-md2 detail type"),"type1"==i(this).attr("id")?(j=1,i(".type2").css("color",""),i(".type1").css("color","#318AF7")):"type2"==i(this).attr("id")&&(j=2,console.log(i(".type2")),i(".type1").css("color",""),i(".type2").css("color","#318AF7"))}),i(document).off("click",".first_s_add").on("click",".first_s_add",function(){var e=i(".first_s_name").val();""!=e&&""!=Trim(e)?(i(".first_s").append('<span class="specifications_first s_click">'+e+"</span>"),i(".first_s_name").val("").focus()):(layer.msg("请填写规格1再添加"),i(".first_s_name").val("").focus())}),i(document).off("click",".second_s_add").on("click",".second_s_add",function(){var e=i(".second_s_name").val();""!=e&&""!=Trim(e)?(i(".second_s").append('<span class="specifications_second s_click">'+e+"</span>"),i(".second_s_name").val("").focus()):(layer.msg("请填写规格2再添加"),i(".second_s_name").val("").focus())}),i(document).off("click",".s_click").on("click",".s_click",function(){"specifications_first s_click"===this.className?i(this).attr("class","specifications_first s_click first_s_click"):"specifications_first s_click first_s_click"===this.className?i(this).attr("class","specifications_first s_click"):"specifications_second s_click"===this.className?i(this).attr("class","specifications_second s_click second_s_click"):"specifications_second s_click second_s_click"===this.className&&i(this).attr("class","specifications_second s_click")}),i(document).off("click",".generate").on("click",".generate",function(){var e=[],a=[];if(i(".first_s_click").each(function(a,t){e.push(t.innerText),i(this).attr("class","specifications_first s_click")}),i(".second_s_click").each(function(e,t){a.push(t.innerText),i(this).attr("class","specifications_second s_click")}),"0"==e.length&&"0"==a.length)return void layer.msg("请至少添加一种规格再生成");if(0===e.length)for(var t=0;t<a.length;t++)i(".save_specifications_list").append(new_specifications("",a[t]));else if(0===a.length)for(var t=0;t<e.length;t++)i(".save_specifications_list").append(new_specifications(e[t]));else for(var t=0;t<e.length;t++)for(var s=0;s<a.length;s++)i(".save_specifications_list").append(new_specifications(e[t],a[s]))}),i(document).off("change",".addImgPut").on("change",".addImgPut",function(){var e=this,a=this.files[0];if(window.FileReader){var t=new FileReader;t.readAsDataURL(a),t.onloadend=function(a){i(e).next().attr("src",a.target.result)}}a=null}),i(document).on("click",".specifications_delete",function(){i(this).parent().remove()}),i(document).on("change",".stock_price",function(){var e=[];i("input[name=stock_price]").each(function(){""!=this.value&&e.push(this.value)}),e.sort(sortNumber),i("#price").val(e[0])}),i(document).on("change",".stock_number",function(){var e=0;i("input[name=stock_number]").each(function(){""!=this.value&&(e+=1*this.value)}),i("#stocks").val(e)}),v&&i.ajax({url:h+"/"+v+k,type:"get",headers:m,beforeSend:function(){a=layer.load(f,_)},success:function(e){if(e.status==u)return layer.msg(d),n.exit(),!1;if(layer.close(a),200!==e.status)return layer.msg(e.message),!1;var t=e.data;j=t.type,i("#type"+j).attr("class","layui-col-md2 detail type"),i(".type"+j).css("color","#318AF7"),i("input[name=name]").val(t.name),i("input[name=code]").val(t.code),F={};var c=t.pic_urls.substr(0,t.pic_urls.length-1).split(",");for(var r in c)x=Math.round(1e9*Math.random()),F[x]=c[r],i("#images").append('<div class="images"><img src="'+c[r]+'" alt="gu'+x+'" class="layui-upload-img goodsImg"><p class="deleteIcon">X</p></div>');for(var o,l=0;l<b.data.length;l++)if(i("select[name=m_category_id]").empty(),b.data[l].hasOwnProperty("sub")){for(var p=!1,m=0;m<b.data[l].sub.length;m++)if(b.data[l].sub[m].id==t.m_category_id){p=!0,o=b.data[l].id;break}if(p){for(var m=0;m<b.data[l].sub.length;m++)i("select[name=m_category_id]").append("<option value="+b.data[l].sub[m].id+">"+b.data[l].sub[m].name+"</option>");break}}i("select[name=m_parent_id]").val(o),i("select[name=m_category_id]").val(t.m_category_id),i("input[name=simple_info]").val(t.simple_info),q.txt.html(t.detail_info);var f=t.stock;if(f.length>0){for(var _=0;_<f.length;_++){var y=f[_].property1_name,v=f[_].property2_name;i(".save_specifications_list").append(new_specifications(y,v,parseFloat(f[_].price),f[_].number,f[_].code,parseFloat(f[_].cost_price),f[_].pic_url))}var g=t.property1,h=t.property2;if(""!=Trim(g)){var k=g.split(":");""!=Trim(k[0])&&i("input[name=property1_key]").val(k[0]);for(var w=k[1].split(","),T=0;T<w.length;T++)i(".first_s").append('<span class="specifications_first s_click">'+w[T]+"</span>")}if(""!=Trim(h)){var I=h.split(":");""!=Trim(I[0])&&i("input[name=property2_key]").val(I[0]);for(var w=h.split(","),T=0;T<w.length;T++)i(".second_s").append('<span class="specifications_second s_click">'+w[T]+"</span>")}}i("input[name=price]").val(parseFloat(t.price)),i("input[name=line_price]").val(parseFloat(t.line_price)),i("input[name=stocks]").val(parseFloat(t.stocks));var S;t.status?t.start_time==t.create_time?S=1:(S=2,i("input[name=diyStartTime]").val(t.diyStartTime)):S=3,i("input[name='start_time'][value='"+S+"']").prop("checked",!0),1==t.is_top?i("input[name=is_top]").prop("checked",!0):i("input[name=is_top]").removeAttr("checked"),s.render()},error:function(){layer.msg(p),layer.close(a)}}),s.on("submit(sub)",function(){if(0==j)return void layer.msg("请选择商品类型");w="";for(var s in F)w+=F[s]+",";if(""==w)return void layer.msg("请添加商品图");if(null==i("select[name=m_category_id]").val())return void layer.msg("请选择商品分组");var c,r,o=h;v?(o=h+"/"+v,r="put",t=l.put):(r="post",t=l.post);var g=[],k=[],b=[],x=[],T=[],I=[],S=[],M=[],A=[];i("img[name='pic_url']").each(function(e,a){g.push(a.src)}),i(".property1_name").each(function(e,a){k.push(a.innerText)}),k.length>0&&(b=duplicateRemoval(k),b=b.join(","),b=i("input[name=property1_key]").val()+":"+b),i(".property2_name").each(function(e,a){T.push(a.innerText)}),T.length>0&&(x=duplicateRemoval(T),x=x.join(","),x=i("input[name=property2_key]").val()+":"+x),i("input[name='stock_price']").each(function(e,a){I.push(a.value)}),i("input[name='stock_number']").each(function(e,a){S.push(a.value)}),i("input[name='stock_code']").each(function(e,a){M.push(a.value)}),i("input[name='stock_cost_price']").each(function(e,a){A.push(a.value)});var N={pic_url:g,property1_name:k,property2_name:T,price:I,number:S,code:M,cost_price:A},O=null,P=1,C=i("input[name=start_time]:checked").val();1==C?O="":2==C?O=i("input[name=diyStartTime]").val():3==C&&(O="",P=0);var R=0;i("input[name=is_top]:checked").val()&&(R=1),c={type:j,name:i("input[name=name]").val(),code:i("input[name=code]").val(),m_category_id:i("select[name=m_category_id]").val(),pic_urls:w,simple_info:i("input[name=simple_info]").val(),detail_info:q.txt.html(),stock:N,property1:b,property2:x,price:i("input[name=price]").val(),line_price:i("input[name=line_price]").val(),stocks:i("input[name=stocks]").val(),start_time:O,is_top:R,status:P,key:y},i.ajax({url:o,data:c,type:r,async:!1,headers:m,beforeSend:function(){a=layer.load(f,_)},success:function(i){return i.status==u?(layer.msg(d),n.exit(),!1):(layer.close(a),200!=i.status?(layer.msg(i.message),!1):void layer.msg(t,{icon:1,time:2e3},function(){layer.close(e),location.hash="/goods/list"}))},error:function(){layer.msg(p),layer.close(a)}})})}),e("goods/add",{})});
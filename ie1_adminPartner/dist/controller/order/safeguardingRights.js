/** layuiAdmin.pro-v1.0.0-beta7 LPPL License By http://www.layui.com/admin/ */
 ;layui.define(function(e){layui.use(["table","jquery","form","admin","setter","laydate","element","upload"],function(){function e(e){H=i.render({elem:"#suborderPageTable",url:f+"/merchantSuborder"+E+"&order_group_sn="+e,page:!0,limit:b,limits:k,loading:!0,cols:[z],response:{statusName:"status",statusCode:"200",dataName:"data"},headers:v,done:function(e){return e.status==g?(layer.msg(h),m.exit(),!1):200!=e.status?(layer.msg(e.message),!1):void 0}})}function t(){o.ajax({url:f+"/merchantShopExpress"+E,type:"get",headers:v,beforeSend:function(){s=layer.load(x,w)},success:function(e){if(e.status==g)return layer.msg(h),m.exit(),!1;if(layer.close(s),200!==e.status)return layer.msg(e.message),!1;for(var t=0;t<e.data.length;t++){var a=e.data[t].name,r=e.data[t].id;o("select[name=express_id]").append("<option value="+r+">"+a+"</option>"),d.render()}S=1},error:function(){layer.msg(p),layer.close(s)}})}var a,r,s,l,n,i=layui.table,o=layui.$,d=layui.form,m=layui.admin,u=layui.setter,f=u.baseUrl,c=layui.laydate,y=(layui.element,layui.upload),_=u.successMsg,p=u.errorMsg,g=u.timeOutCode,h=u.timeOutMsg,v={"Access-Token":layui.data(u.tableName).access_token},x=1,w={shade:.3},b=10,k=[10,20,30],T=sessionStorage.getItem("saa_key"),S=0;d.render(),c.render({elem:"#start_time",type:"datetime"}),c.render({elem:"#end_time",type:"datetime"});var M=new Date,N=(new Date).format("yyyy-MM-dd hh:mm:ss"),j=new Date(M.getTime()-6048e5).format("yyyy-MM-dd hh:mm:ss"),O=new Date(M.getTime()-2592e6).format("yyyy-MM-dd hh:mm:ss");o(document).off("click",".seven_day").on("click",".seven_day",function(e){o("input[name=start_time]").val(j),o("input[name=end_time]").val(N)}),o(document).off("click",".thirty_day").on("click",".thirty_day",function(e){o("input[name=start_time]").val(O),o("input[name=end_time]").val(N)});var A,I="",D=[],P=[],C={},F=1,R=0;y.render({elem:"#putAddBtn",url:f+"/merchantOrderImg",headers:v,multiple:!0,before:function(e){F=0,e.preview(function(e,t,a){A=Math.round(1e9*Math.random()),D.push(A),o("#images").append('<div class="images"><img src="'+a+'" alt="gu'+A+'" class="layui-upload-img goodsImg"><span class="deleteIcon ">&times;</span></div>')})},done:function(e){if(200==e.code){R++,P.push(e.data.src);for(var t=D.length,a=0;a<t;a++)C[D[a]]=P[a];R==t&&(F=1)}}}),o(document).on("click",".deleteIcon",function(){var e=this.parentNode,t=o(this).prev("img").attr("alt");layer.open({title:"删除",content:"确认删除这张图片吗",yes:function(a){t=t.substr(2,t.length),delete C[t],e.remove(),layer.close(a)}})});var q,B=f+"/merchantSale",E="?key="+T,G=0;i.on("tool(pageTable)",function(t){var r=t.data;console.log(r);var i=t.event;if(l=r.id,n=r.order_sn,"show"===i){o("#su_nickname").text(r.su_nickname),o("#total_price").text(parseFloat(r.total_price)),o("#sv_price").text(parseFloat(r.sv_price)),o("#payment_money").text(parseFloat(r.payment_money)),o("#create_time").text(r.create_time);var d="";d="0"==r.status?"待付款":"1"==r.status?"待发货":"2"==r.status?"已取消":"3"==r.status?"已发货":"4"==r.status?"已退款":"5"==r.status?"退款中":"6"==r.status?"待评价":"7"==r.status?"已完成":"类型错误",o("#order_status").text(d);var u="";u="-1"==r.after_sale?"未退款":"0"==r.after_sale?"退款中":"1"==r.after_sale?"退款成功":"2"==r.after_sale?"退款失败":"类型错误",o("#order_after_sale").text(u),o("#remark").text(r.remark),o("#admin_remark").text(r.admin_remark),a=layer.open({type:1,title:"子订单",content:o("#suborder"),shade:0,area:["70vw","60vh"]}),e(r.order_sn)}else if("show_after_sale"===i){o.ajax({url:f+"/merchantSuborder"+E+"&order_group_sn="+r.order_sn,type:"get",async:!1,headers:v,beforeSend:function(){s=layer.load(x,w)},success:function(e){return layer.close(s),e.status==g?(layer.msg(h),m.exit(),!1):200!=e.status?(layer.msg(e.message),!1):e.data.length<=0?void layer.msg("订单错误，子订单不存在"):(q=0,void(null!=e.data[0].express_id&&(q=1)))},error:function(){layer.msg(p),layer.close(s)}}),G=r.after_type;var c=0;c="1"==G?"退款退货":"2"==G?"只退款":"类型错误",o("#after_type").text(c),o("#after_remark").text(r.after_remark);for(var y=Trim(r.after_imgs).split(","),_="",b=0;b<y.length;b++)_+='<img style="width: 100px;height: 100px" src="'+y[b]+'" />';if(o("#after_imgs").empty(),o("#after_imgs").append(_),o(".after_sale_agree_info").hide(),o(".after_sale_operation").hide(),o(".after_sale_refuse_info").hide(),1==r.after_sale)q&&o(".after_sale_agree_info").show();else if(2==r.after_sale){o("#after_admin_remark").text(r.after_admin_remark);for(var k=Trim(r.after_admin_imgs).split(","),T="",b=0;b<k.length;b++)T+='<img style="width: 100px;height: 100px" src="'+k[b]+'" />';o("#after_admin_imgs").empty(),o("#after_admin_imgs").append(T),o(".after_sale_refuse_info").show()}else o(".after_sale_operation").show();a=layer.open({type:1,title:"退款详情",content:o("#after_sale_form"),shade:0,offset:"12vw",area:["30vw","auto"]})}else layer.msg(p)});var U=[{field:"su_nickname",title:"购买用户",width:"6%"},{field:"order_sn",title:"订单号",width:"14%"},{field:"total_price",title:"订单总额",templet:"#totalPriceTpl",width:"6%"},{field:"sv_price",title:"优惠金额",templet:"#svPriceTpl",width:"6%"},{field:"payment_money",title:"付款总额",edit:"text",templet:"#paymentMoneyTpl",width:"6%"},{field:"after_sale",title:"售后",templet:"#afterSaleTpl",width:"6%"},{field:"status",title:"订单状态",templet:"#statusTpl",width:"6%"},{field:"remark",title:"备注",width:"12%"},{field:"admin_remark",title:"管理员备注",edit:"text",width:"12%"},{field:"create_time",title:"创建时间",width:"11%"},{field:"operations",title:"操作",toolbar:"#operations",width:"15%"}],$=i.render({elem:"#pageTable",url:B+E,page:!0,limit:b,limits:k,loading:!0,cols:[U],response:{statusName:"status",statusCode:"200",dataName:"data"},headers:v,done:function(e){return e.status==g?(layer.msg(h),m.exit(),!1):200!=e.status?(layer.msg(e.message),!1):void 0}});d.on("submit(find)",function(e){$.reload({where:{searchNameType:e.field.searchNameType,searchName:e.field.searchName,start_time:e.field.start_time,end_time:e.field.end_time,goods_name:e.field.goods_name,after_sale:e.field.after_sale,status:e.field.status},page:{curr:1}})});var z=[{field:"pic_urls",title:"图片",templet:"#imgTpl",width:"25%"},{field:"goods_name",title:"商品名称",width:"25%"},{field:"number",title:"数量",width:"25%"},{field:"total_price",title:"订单总额",templet:"#totalPriceTpl",width:"25%"}],H="";d.on("submit(expressSub)",function(){var e={order_sn:n,express_id:o("select[name=express_id]").val(),express_number:o("input[name=express_number]").val(),key:T};o.ajax({url:f+"/merchantSend",data:e,type:"put",async:!1,headers:v,beforeSend:function(){s=layer.load(x,w)},success:function(e){return e.status==g?(layer.msg(h),m.exit(),!1):(layer.close(s),200!=e.status?(layer.msg(e.message),!1):(layer.msg("发货成功"),layer.close(a),o("#send_form")[0].reset(),void $.reload()))},error:function(){layer.msg(p),layer.close(s)}})}),d.on("submit(agree_refund)",function(){layer.confirm("确定同意该订单的退款请求吗?",function(e){layer.close(e),1==G?o.ajax({url:f+"/merchantAfterInfo"+E,type:"get",async:!1,headers:v,beforeSend:function(){s=layer.load(x,w)},success:function(e){if(layer.close(s),e.status==g)return layer.msg(h),m.exit(),!1;if(200!=e.status)return layer.msg(e.message),!1;if(e.data.length<=0)return void layer.msg("未查询到收货信息，请新创建");var t={after_phone:e.data[0].after_phone,after_addr:e.data[0].after_addr,key:T};o.ajax({url:f+"/merchantOrderAgreeGoods/"+l,data:t,type:"put",async:!1,headers:v,beforeSend:function(){s=layer.load(x,w)},success:function(e){return e.status==g?(layer.msg(h),m.exit(),!1):(layer.close(s),200!=e.status?(layer.msg(e.message),!1):(layer.msg("同意退款成功"),layer.close(a),o("#send_form")[0].reset(),void $.reload()))},error:function(){layer.msg(p),layer.close(s)}})},error:function(){layer.msg(p),layer.close(s)}}):o.ajax({url:f+"/merchantOrderAgreeMoney/"+l,data:{key:T},type:"put",async:!1,headers:v,beforeSend:function(){s=layer.load(x,w)},success:function(e){return e.status==g?(layer.msg(h),m.exit(),!1):(layer.close(s),200!=e.status?(layer.msg(e.message),!1):(layer.msg("同意退款成功"),layer.close(a),o("#send_form")[0].reset(),void $.reload()))},error:function(){layer.msg(p),layer.close(s)}})})}),d.on("submit(refuse_refund)",function(){layer.close(a),q?r=layer.open({type:1,title:"退款详情",content:o("#refuse_form"),shade:0,offset:"12vw",area:["30vw","auto"]}):(S||t(),a=layer.open({type:1,title:"填写物流",content:o("#send_form"),shade:0,offset:"12vw",area:["50vw","auto"]}))}),d.on("submit(refuse)",function(e){if(!F)return void layer.msg("请等待图片上传");I="";for(var t in C)I+=C[t]+",";var a={after_admin_remark:e.field.after_admin_remark,after_admin_imgs:I,key:T};o.ajax({url:f+"/merchantOrderRefuse/"+l,type:"put",data:a,async:!1,headers:v,success:function(e){return e.status==g?(layer.msg(h),m.exit(),!1):(layer.close(s),200!=e.status?(layer.msg(e.message),!1):(layer.msg(_.put),layer.close(r),o("#after_sale_form")[0].reset(),o("#refuse_form")[0].reset(),o(".layui-upload-list").empty(),void $.reload()))},error:function(){layer.msg(p),layer.close(s)},beforeSend:function(){s=layer.load(x,w)}})}),d.on("submit(confirmation_of_receipt)",function(){layer.confirm("该订单确认收货吗?",function(e){o.ajax({url:f+"/merchantOrderAgreeMoney/"+l,type:"put",data:{key:T},async:!1,headers:v,success:function(t){return t.status==g?(layer.msg(h),m.exit(),!1):(layer.close(s),200!=t.status?(layer.msg(t.message),!1):(layer.msg("确认收货成功"),layer.close(e),layer.close(a),void $.reload()))},error:function(){layer.msg(p),layer.close(s)},beforeSend:function(){s=layer.load(x,w)}})})})}),e("order/safeguardingRights",{})});
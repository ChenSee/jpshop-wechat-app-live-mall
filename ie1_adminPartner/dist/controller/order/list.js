/** layuiAdmin.pro-v1.0.0-beta7 LPPL License By http://www.layui.com/admin/ */
 ;layui.define(function(e){layui.use(["table","jquery","form","admin","setter","laydate","element","upload"],function(){function e(e){var t=[{field:"su_nickname",title:"购买用户",width:"6%"},{field:"order_sn",title:"订单号",width:"14%"},{field:"total_price",title:"订单总额",templet:"#totalPriceTpl",width:"6%"},{field:"sv_price",title:"优惠金额",templet:"#svPriceTpl",width:"6%"},{field:"payment_money",title:"付款总额",edit:"text",templet:"#paymentMoneyTpl",width:"6%"},{field:"after_sale",title:"退款状态",templet:"#afterSaleTpl",width:"6%"},{field:"status",title:"订单状态",templet:"#statusTpl",width:"6%"},{field:"remark",title:"备注",width:"12%"},{field:"admin_remark",title:"管理员备注",edit:"text",width:"12%"},{field:"create_time",title:"创建时间",width:"11%"},{field:"operations",title:"操作",toolbar:"#operations"+$,width:"15%"}];H=o.render({elem:"#pageTable"+e,url:R+U+"&status="+e,page:!0,limit:T,limits:S,loading:!0,cols:[t],response:{statusName:"status",statusCode:"200",dataName:"data"},headers:b,done:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):200!=e.status?(layer.msg(e.message),!1):void 0}})}function t(e){K=o.render({elem:"#suborderPageTable",url:c+"/merchantSuborder"+U+"&order_group_sn="+e,page:!0,limit:T,limits:S,loading:!0,cols:[J],response:{statusName:"status",statusCode:"200",dataName:"data"},headers:b,done:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):200!=e.status?(layer.msg(e.message),!1):void 0}})}function a(){d.ajax({url:c+"/merchantShopExpress"+U,type:"get",headers:b,beforeSend:function(){l=layer.load(w,k)},success:function(e){if(e.status==v)return layer.msg(x),u.exit(),!1;if(layer.close(l),200!==e.status)return layer.msg(e.message),!1;for(var t=0;t<e.data.length;t++){var a=e.data[t].name,r=e.data[t].id;d("select[name=express_id]").append("<option value="+r+">"+a+"</option>"),m.render()}N=1},error:function(){layer.msg(h),layer.close(l)}})}var r,s,l,n,i,o=layui.table,d=layui.$,m=layui.form,u=layui.admin,f=layui.setter,c=f.baseUrl,y=layui.laydate,p=layui.element,_=layui.upload,g=f.successMsg,h=f.errorMsg,v=f.timeOutCode,x=f.timeOutMsg,b={"Access-Token":layui.data(f.tableName).access_token},w=1,k={shade:.3},T=10,S=[10,20,30],M=sessionStorage.getItem("saa_key"),N=0;m.render(),y.render({elem:"#start_time",type:"datetime"}),y.render({elem:"#end_time",type:"datetime"});var j=new Date,A=(new Date).format("yyyy-MM-dd hh:mm:ss"),O=new Date(j.getTime()-6048e5).format("yyyy-MM-dd hh:mm:ss"),I=new Date(j.getTime()-2592e6).format("yyyy-MM-dd hh:mm:ss");d(document).off("click",".seven_day").on("click",".seven_day",function(e){d("input[name=start_time]").val(O),d("input[name=end_time]").val(A)}),d(document).off("click",".thirty_day").on("click",".thirty_day",function(e){d("input[name=start_time]").val(I),d("input[name=end_time]").val(A)});var C,D="",P=[],F=[],q={},B=1,E=0;_.render({elem:"#putAddBtn",url:c+"/merchantOrderImg",headers:b,multiple:!0,before:function(e){B=0,e.preview(function(e,t,a){C=Math.round(1e9*Math.random()),P.push(C),d("#images").append('<div class="images"><img src="'+a+'" alt="gu'+C+'" class="layui-upload-img goodsImg"><span class="deleteIcon ">&times;</span></div>')})},done:function(e){if(200==e.code){E++,F.push(e.data.src);for(var t=P.length,a=0;a<t;a++)q[P[a]]=F[a];E==t&&(B=1)}}}),d(document).on("click",".deleteIcon",function(){var e=this.parentNode,t=d(this).prev("img").attr("alt");layer.open({title:"删除",content:"确认删除这张图片吗",yes:function(a){t=t.substr(2,t.length),delete q[t],e.remove(),layer.close(a)}})});var G,R=c+"/merchantOrder",U="?key="+M,$="",z=0;o.on("tool(pageTable)",function(e){var s=e.data,o=e.event;if(n=s.id,i=s.order_sn,"show"===o){d("#su_nickname").text(s.su_nickname),d("#total_price").text(parseFloat(s.total_price)),d("#sv_price").text(parseFloat(s.sv_price)),d("#payment_money").text(parseFloat(s.payment_money)),d("#create_time").text(s.create_time);var m="";m="0"==s.status?"待付款":"1"==s.status?"待发货":"2"==s.status?"已取消":"3"==s.status?"已发货":"4"==s.status?"已退款":"5"==s.status?"退款中":"6"==s.status?"待评价":"7"==s.status?"已完成":"类型错误",d("#order_status").text(m);var f="";f="-1"==s.after_sale?"未退款":"0"==s.after_sale?"退款中":"1"==s.after_sale?"退款成功":"2"==s.after_sale?"退款失败":"类型错误",d("#order_after_sale").text(f),d("#remark").text(s.remark),d("#admin_remark").text(s.admin_remark),r=layer.open({type:1,title:"子订单",content:d("#suborder"),shade:0,area:["70vw","60vh"]}),t(s.order_sn)}else if("send"===o)N||a(),r=layer.open({type:1,title:"填写物流",content:d("#send_form"),shade:0,offset:"12vw",area:["50vw","auto"]});else if("cancel"===o)layer.confirm("确定要取消该订单吗?",function(e){layer.close(e),d.ajax({url:c+"/merchantOrderCancel/"+s.id,data:{key:M},type:"put",async:!1,headers:b,beforeSend:function(){l=layer.load(w,k)},success:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):(layer.close(l),200!=e.status?(layer.msg(e.message),!1):(layer.msg(e.message),void H.reload()))},error:function(){layer.msg(h),layer.close(l)}})});else if("show_after_sale"===o){d.ajax({url:c+"/merchantSuborder"+U+"&order_group_sn="+s.order_sn,type:"get",async:!1,headers:b,beforeSend:function(){l=layer.load(w,k)},success:function(e){return layer.close(l),e.status==v?(layer.msg(x),u.exit(),!1):200!=e.status?(layer.msg(e.message),!1):e.data.length<=0?void layer.msg("订单错误，子订单不存在"):(G=0,void(null!=e.data[0].express_id&&(G=1)))},error:function(){layer.msg(h),layer.close(l)}}),z=s.after_type;var y=0;y="1"==z?"退款退货":"2"==z?"只退款":"类型错误",d("#after_type").text(y),d("#after_remark").text(s.after_remark);for(var p=Trim(s.after_imgs).split(","),_="",g=0;g<p.length;g++)_+='<img style="width: 100px;height: 100px" src="'+p[g]+'" />';if(d("#after_imgs").empty(),d("#after_imgs").append(_),d(".after_sale_agree_info").hide(),d(".after_sale_operation").hide(),d(".after_sale_refuse_info").hide(),1==s.after_sale)G&&d(".after_sale_agree_info").show();else if(2==s.after_sale){d("#after_admin_remark").text(s.after_admin_remark);for(var T=Trim(s.after_admin_imgs).split(","),S="",g=0;g<T.length;g++)S+='<img style="width: 100px;height: 100px" src="'+T[g]+'" />';d("#after_admin_imgs").empty(),d("#after_admin_imgs").append(S),d(".after_sale_refuse_info").show()}else d(".after_sale_operation").show();r=layer.open({type:1,title:"退款详情",content:d("#after_sale_form"),shade:0,offset:"12vw",area:["30vw","auto"]})}else layer.msg(h)}),p.on("tab(tab)",function(){$=this.getAttribute("lay-id"),d("select[name=status]").val($),e($),m.render()});var H="";e(""),o.on("edit(pageTable)",function(e){var t={key:M};if("payment_money"===e.field){if(isNaN(e.value))return void layer.msg("修改失败");t.payment_money=e.field}else"admin_remark"===e.field&&(t.payment_money=e.field);d.ajax({url:R+"/"+e.data.id,type:"put",data:{admin_remark:e.value,key:M},async:!1,headers:b,success:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):(layer.close(l),200!=e.status?(layer.msg(e.message),!1):void layer.msg(g.put))},error:function(){layer.msg(h),layer.close(l)},beforeSend:function(){l=layer.load(w,k)}})}),m.on("submit(find)",function(e){d(".layui-tab").find("li").each(function(){d(this).removeAttr("class"),$=this.getAttribute("lay-id"),$===e.field.status&&d(this).attr("class","layui-this")}),H.reload({where:{searchNameType:e.field.searchNameType,searchName:e.field.searchName,start_time:e.field.start_time,end_time:e.field.end_time,goods_name:e.field.goods_name,after_sale:e.field.after_sale,status:e.field.status},page:{curr:1}})});var J=[{field:"pic_urls",title:"图片",templet:"#imgTpl",width:"25%"},{field:"goods_name",title:"商品名称",width:"25%"},{field:"number",title:"数量",width:"25%"},{field:"total_price",title:"订单总额",templet:"#totalPriceTpl",width:"25%"}],K="";m.on("submit(expressSub)",function(){var e={order_sn:i,express_id:d("select[name=express_id]").val(),express_number:d("input[name=express_number]").val(),key:M};d.ajax({url:c+"/merchantSend",data:e,type:"put",async:!1,headers:b,beforeSend:function(){l=layer.load(w,k)},success:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):(layer.close(l),200!=e.status?(layer.msg(e.message),!1):(layer.msg("发货成功"),layer.close(r),d("#send_form")[0].reset(),void H.reload()))},error:function(){layer.msg(h),layer.close(l)}})}),m.on("submit(agree_refund)",function(){layer.confirm("确定同意该订单的退款请求吗?",function(e){layer.close(e),1==z?d.ajax({url:c+"/merchantAfterInfo"+U,type:"get",async:!1,headers:b,beforeSend:function(){l=layer.load(w,k)},success:function(e){if(layer.close(l),e.status==v)return layer.msg(x),u.exit(),!1;if(200!=e.status)return layer.msg(e.message),!1;if(e.data.length<=0)return void layer.msg("未查询到收货信息，请新创建");var t={after_phone:e.data[0].after_phone,after_addr:e.data[0].after_addr,key:M};d.ajax({url:c+"/merchantOrderAgreeGoods/"+n,data:t,type:"put",async:!1,headers:b,beforeSend:function(){l=layer.load(w,k)},success:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):(layer.close(l),200!=e.status?(layer.msg(e.message),!1):(layer.msg("同意退款成功"),layer.close(r),d("#send_form")[0].reset(),void H.reload()))},error:function(){layer.msg(h),layer.close(l)}})},error:function(){layer.msg(h),layer.close(l)}}):d.ajax({url:c+"/merchantOrderAgreeMoney/"+n,data:{key:M},type:"put",async:!1,headers:b,beforeSend:function(){l=layer.load(w,k)},success:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):(layer.close(l),200!=e.status?(layer.msg(e.message),!1):(layer.msg("同意退款成功"),layer.close(r),d("#send_form")[0].reset(),void H.reload()))},error:function(){layer.msg(h),layer.close(l)}})})}),m.on("submit(refuse_refund)",function(){layer.close(r),G?s=layer.open({type:1,title:"退款详情",content:d("#refuse_form"),shade:0,offset:"12vw",area:["30vw","auto"]}):(N||a(),r=layer.open({type:1,title:"填写物流",content:d("#send_form"),shade:0,offset:"12vw",area:["50vw","auto"]}))}),m.on("submit(refuse)",function(e){if(!B)return void layer.msg("请等待图片上传");D="";for(var t in q)D+=q[t]+",";var a={after_admin_remark:e.field.after_admin_remark,after_admin_imgs:D,key:M};d.ajax({url:c+"/merchantOrderRefuse/"+n,type:"put",data:a,async:!1,headers:b,success:function(e){return e.status==v?(layer.msg(x),u.exit(),!1):(layer.close(l),200!=e.status?(layer.msg(e.message),!1):(layer.msg(g.put),layer.close(s),d("#after_sale_form")[0].reset(),d("#refuse_form")[0].reset(),d(".layui-upload-list").empty(),void H.reload()))},error:function(){layer.msg(h),layer.close(l)},beforeSend:function(){l=layer.load(w,k)}})}),m.on("submit(confirmation_of_receipt)",function(){layer.confirm("该订单确认收货吗?",function(e){d.ajax({url:c+"/merchantOrderAgreeMoney/"+n,type:"put",data:{key:M},async:!1,headers:b,success:function(t){return t.status==v?(layer.msg(x),u.exit(),!1):(layer.close(l),200!=t.status?(layer.msg(t.message),!1):(layer.msg("确认收货成功"),layer.close(e),layer.close(r),void H.reload()))},error:function(){layer.msg(h),layer.close(l)},beforeSend:function(){l=layer.load(w,k)}})})})}),e("order/list",{})});